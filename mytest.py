import os.path

from ultralytics import YOLO
from pathlib import Path
import time
from pycocotools.coco import COCO
from pycocotools.cocoeval import COCOeval

if __name__ == "__main__":
    # 1. 加载模型
    model = YOLO(r"D:\Models\YOLOS4A-l.pt")

    FF = ["CA", "ECA", "SE"]
    for ff in FF:
        if ff in str(model.model):
            print(ff)
    print(model.model)

    # 2. 计算参数量（单位：百万）
    num_params = sum(p.numel() for p in model.model.parameters()) / 1e6

    # 2. 设置数据集路径
    data_yaml = r"D:\codes\YOLOS4A\myVisDrone.yaml"

    # 指定保存路径
    save_dir = Path(r"D:\codes\YOLOS4A\runs\detect\custom_val")  # 自定义保存目录

    # 3. 开始验证并计时
    start = time.time()
    # 指定保存路径并保存JSON
    metrics = model.val(
        data=data_yaml,
        imgsz=1024,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        split="val",
        save_json=True,
        project=save_dir.parent,  # 项目目录
        name=save_dir.name,  # 实验名称，最终会保存在project/name目录下
        exist_ok=True
    )
    elapsed = time.time() - start

    # 4. 提取关键指标
    mAP50_95 = metrics.box.map  # mAP50-95
    mAP50 = metrics.box.map50  # mAP50
    sec_per_img = metrics.speed['inference'] / 1000.0  # 推理速度 (Sec/img)

    # 加载标注文件
    ann_file = r"D:\Datas\VisDrone\coco\VisDrone2019-DET_val_coco.json"
    coco_gt = COCO(ann_file)
    coco_gt.dataset['info'] = {}

    # 直接使用内存中的预测结果，无需读取JSON文件
    pred_file = os.path.join(save_dir, "predictions.json")
    # 转换YOLO格式的预测结果为COCO评估所需格式
    coco_dt = coco_gt.loadRes(pred_file)  # 关键修改：使用metrics中的预测数据

    # 进行评估
    coco_eval = COCOeval(coco_gt, coco_dt, iouType='bbox')
    # 修改面积划分为VisDrone规则
    # coco_eval.params.areaRng = [
    #     [0, 1e5 ** 2],  # all
    #     # [2,8],#very tiny
    #     # [8, 16],  # tiny
    #     # [16, 32],  # small
    # ]
    coco_eval.evaluate()
    coco_eval.accumulate()
    coco_eval.summarize()

    # 提取各面积类别的AP（注意索引对应关系）
    # stats数组中，AP@[0.5:0.95]的各面积类别从索引3开始依次排列
    AP_all = coco_eval.stats[0]  # 对应all
    AP_very_tiny = coco_eval.stats[3]  # 对应very tiny
    AP_tiny = coco_eval.stats[4]  # 对应tiny
    AP_small = coco_eval.stats[5]  # 对应small

    # 提取Precision / Recall
    precision = metrics.box.mp  # mean precision
    recall = metrics.box.mr  # mean recall

    FPS=1/sec_per_img

    # 打印结果
    print("====== VisDrone Validation Results ======")
    print(f"Params\tAP  \tmAP50\tAP_vt\tAP_t\tAP_s\ts/img\tFPS")
    print(f"{num_params:.3f}\t{mAP50_95:.3f}\t{mAP50:.3f}\t{AP_very_tiny:.3f}\t{AP_tiny:.3f}\t{AP_small:.3f}\t{sec_per_img:.3f}\t{FPS:.2f}")
